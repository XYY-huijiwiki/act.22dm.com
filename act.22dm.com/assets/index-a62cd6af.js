import{_ as a,d as e,r as t,e as l,an as s,o as n,c as i,j as d,t as c,F as o,m as v,z as u,l as r,O as h,P as b,B as m,q as g,A as p,V as f,x as y}from"./index-3ebeac6f.js";const w=a=>(h("data-v-4a7886b0"),a=a(),b(),a),M={class:"ar-detector"},x={class:"detector-header"},k=w((()=>d("h2",null,"高级AR检测器",-1))),C={class:"detector-controls"},_=["disabled"],A=["disabled"],E=["disabled"],j={class:"detector-content"},$={class:"video-wrapper"},I={key:0,class:"detection-3d"},D=[m('<div class="cube" data-v-4a7886b0><div class="face front" data-v-4a7886b0></div><div class="face back" data-v-4a7886b0></div><div class="face right" data-v-4a7886b0></div><div class="face left" data-v-4a7886b0></div><div class="face top" data-v-4a7886b0></div><div class="face bottom" data-v-4a7886b0></div></div>',1)],F=[m('<div class="bbox-line top" data-v-4a7886b0></div><div class="bbox-line right" data-v-4a7886b0></div><div class="bbox-line bottom" data-v-4a7886b0></div><div class="bbox-line left" data-v-4a7886b0></div><div class="corner-marker tl" data-v-4a7886b0></div><div class="corner-marker tr" data-v-4a7886b0></div><div class="corner-marker bl" data-v-4a7886b0></div><div class="corner-marker br" data-v-4a7886b0></div>',8)],W={class:"info-header"},q={class:"object-name"},z={class:"confidence"},P={class:"info-details"},R={class:"detail-item"},H=w((()=>d("span",{class:"label"},"位置:",-1))),O={class:"value"},T={class:"detail-item"},U=w((()=>d("span",{class:"label"},"尺寸:",-1))),L={class:"value"},V={class:"detector-stats"},B=w((()=>d("h3",null,"检测统计",-1))),S={class:"stats-grid"},G={class:"stat-item"},J={class:"stat-value"},K=w((()=>d("div",{class:"stat-label"},"检测对象",-1))),N={class:"stat-item"},Q={class:"stat-value"},X=w((()=>d("div",{class:"stat-label"},"平均置信度",-1))),Y={class:"stat-item"},Z={class:"stat-value"},aa=w((()=>d("div",{class:"stat-label"},"检测FPS",-1))),ea={class:"stat-item"},ta={class:"stat-value"},la=w((()=>d("div",{class:"stat-label"},"模型状态",-1))),sa={key:0,class:"detection-log"},na=w((()=>d("h4",null,"检测历史",-1))),ia={class:"log-list"},da={class:"log-time"},ca={class:"log-object"},oa={class:"log-confidence"},va=a(e({__name:"ARDetector",props:{isCameraActive:{type:Boolean},videoElement:{}},setup(a){const e=a,h=t(),b=t(),m=t(!1),g=t(!1),p=t(!1),f=t([]),y=t([]),w=t(0),va=t(0),ua=t(0),ra=l((()=>{if(0===f.value.length)return 0;return f.value.reduce(((a,e)=>a+e.confidence),0)/f.value.length})),ha=async()=>{m.value=!0;try{await new Promise((a=>setTimeout(a,2e3))),g.value=!0}catch(a){alert("模型加载失败，请重试")}finally{m.value=!1}},ba=()=>{g.value&&e.isCameraActive&&(p.value=!0,ga())},ma=()=>{p.value=!1,f.value=[]},ga=async()=>{if(!p.value||!e.videoElement||!b.value)return;const a=e.videoElement,t=b.value;if(!t.getContext("2d")||0===a.videoWidth)return void requestAnimationFrame(ga);t.width=a.videoWidth,t.height=a.videoHeight;const l=performance.now();ua.value++,l-va.value>=1e3&&(w.value=Math.round(1e3*ua.value/(l-va.value)),ua.value=0,va.value=l);const s=await pa(a.videoWidth,a.videoHeight);f.value=s,s.forEach((a=>{a.confidence>.7&&y.value.push({timestamp:(new Date).toLocaleTimeString(),object:a.class,confidence:a.confidence})})),y.value.length>50&&(y.value=y.value.slice(-50)),requestAnimationFrame(ga)},pa=async(a,e)=>{await new Promise((a=>setTimeout(a,50)));const t=[],l=["人","汽车","手机","杯子","书","椅子","桌子","电脑"],s=Math.floor(4*Math.random())+1;for(let n=0;n<s;n++){const s=Math.random()*(a-150),n=Math.random()*(e-150),i=80+120*Math.random(),d=80+120*Math.random();t.push({class:l[Math.floor(Math.random()*l.length)],confidence:.5+.5*Math.random(),x:s,y:n,width:i,height:d,timestamp:Date.now()})}return t},fa=a=>({left:`${a.x}px`,top:`${a.y}px`,width:`${a.width}px`,height:`${a.height}px`}),ya=a=>({top:a.y<50?"100%":"-60px",left:"0px"});return s((()=>{ma()})),(a,e)=>(n(),i("div",M,[d("div",x,[k,d("div",C,[d("button",{onClick:ha,disabled:m.value||g.value,class:"btn btn-info"},c(m.value?"加载中...":"加载模型"),9,_),d("button",{onClick:ba,disabled:!g.value||!a.isCameraActive,class:"btn btn-success"}," 开始高级检测 ",8,A),d("button",{onClick:ma,disabled:!p.value,class:"btn btn-warning"}," 停止检测 ",8,E)])]),d("div",j,[d("div",$,[d("video",{ref_key:"advancedVideo",ref:h,autoplay:"",muted:"",playsinline:"",class:"advanced-video"},null,512),d("canvas",{ref_key:"advancedCanvas",ref:b,class:"detection-canvas"},null,512),(n(!0),i(o,null,v(f.value,((a,e)=>(n(),i("div",{key:e,class:"advanced-detection",style:u(fa(a))},[a.confidence>.8?(n(),i("div",I,D)):r("",!0),d("div",{class:"advanced-bbox",style:u({width:"100%",height:"100%"})},F,4),d("div",{class:"detection-info",style:u(ya(a))},[d("div",W,[d("span",q,c(a.class),1),d("span",z,c(Math.round(100*a.confidence))+"%",1)]),d("div",P,[d("div",R,[H,d("span",O,"("+c(Math.round(a.x))+", "+c(Math.round(a.y))+")",1)]),d("div",T,[U,d("span",L,c(Math.round(a.width))+"×"+c(Math.round(a.height)),1)])])],4)],4)))),128))]),d("div",V,[B,d("div",S,[d("div",G,[d("div",J,c(f.value.length),1),K]),d("div",N,[d("div",Q,c(Math.round(100*ra.value))+"%",1),X]),d("div",Y,[d("div",Z,c(w.value),1),aa]),d("div",ea,[d("div",ta,c(g.value?"已加载":"未加载"),1),la])]),y.value.length>0?(n(),i("div",sa,[na,d("div",ia,[(n(!0),i(o,null,v(y.value.slice(-5),((a,e)=>(n(),i("div",{key:e,class:"log-item"},[d("span",da,c(a.timestamp),1),d("span",ca,c(a.object),1),d("span",oa,c(Math.round(100*a.confidence))+"%",1)])))),128))])])):r("",!0)])])]))}}),[["__scopeId","data-v-4a7886b0"]]),ua=a=>(h("data-v-b9ee6d68"),a=a(),b(),a),ra={class:"ar-container"},ha={class:"ar-header"},ba=ua((()=>d("h1",null,"AR图像识别",-1))),ma={class:"target-image-section"},ga=ua((()=>d("h3",null,"目标图像设置",-1))),pa={class:"image-input-group"},fa=["disabled"],ya={class:"preset-images"},wa=ua((()=>d("p",{class:"preset-label"},"或选择预设图片：",-1))),Ma={class:"preset-buttons"},xa={key:0,class:"target-image-preview"},ka=["src"],Ca=ua((()=>d("p",{class:"image-info"},"目标图像已加载，可以开始识别",-1))),_a={class:"controls"},Aa=["disabled"],Ea=["disabled"],ja=["disabled"],$a={class:"ar-content"},Ia={class:"video-container"},Da={key:0,class:"detection-animation"},Fa=[ua((()=>d("div",{class:"pulse-ring"},null,-1))),ua((()=>d("div",{class:"pulse-dot"},null,-1)))],Wa=[ua((()=>d("div",{class:"corner top-left"},null,-1))),ua((()=>d("div",{class:"corner top-right"},null,-1))),ua((()=>d("div",{class:"corner bottom-left"},null,-1))),ua((()=>d("div",{class:"corner bottom-right"},null,-1)))],qa={class:"detection-label"},za={class:"info-panel"},Pa=ua((()=>d("h3",null,"检测信息",-1))),Ra={class:"status"},Ha={key:0,class:"detection-indicator"},Oa=[ua((()=>d("div",{class:"pulse-dot"},null,-1))),ua((()=>d("span",null,"正在检测目标图像...",-1)))],Ta={key:0,class:"detection-list"},Ua=ua((()=>d("h4",null,"检测结果:",-1))),La=ua((()=>d("strong",null,"对象:",-1))),Va=ua((()=>d("strong",null,"置信度:",-1))),Ba=ua((()=>d("strong",null,"坐标:",-1))),Sa=ua((()=>d("strong",null,"尺寸:",-1))),Ga=a(e({__name:"index",setup(a){const e=t(),l=t(),h=t(!1),b=t(!1),m=t([]),w=t(null),M=t(""),x=t(!1),k=t(null),C=async()=>{try{const a={video:{width:{ideal:1280},height:{ideal:720},facingMode:"environment"}};w.value=await navigator.mediaDevices.getUserMedia(a),e.value&&(e.value.srcObject=w.value,h.value=!0)}catch(a){alert("无法访问摄像头，请检查权限设置")}},_=()=>{w.value&&(w.value.getTracks().forEach((a=>a.stop())),w.value=null),e.value&&(e.value.srcObject=null),h.value=!1,b.value=!1,m.value=[]},A=()=>{b.value=!b.value,b.value?E():j()},E=()=>{if(!e.value||!l.value)return;const a=e.value,t=l.value;t.getContext("2d")&&(t.width=a.videoWidth,t.height=a.videoHeight,D())},j=()=>{m.value=[]},$=async()=>{if(M.value)try{const a=new Image;a.crossOrigin="anonymous",await new Promise(((e,t)=>{a.onload=e,a.onerror=t,a.src=M.value})),k.value=a,x.value=!0}catch(a){alert("目标图像加载失败，请检查URL是否正确")}},I=async a=>{M.value=a,await $()},D=async()=>{if(!(b.value&&e.value&&l.value&&k.value))return;const a=e.value;if(!l.value.getContext("2d")||0===a.videoWidth)return void requestAnimationFrame(D);const t=await F(a,k.value);m.value=t,requestAnimationFrame(D)},F=async(a,e)=>{const t=document.createElement("canvas"),l=t.getContext("2d");if(!l)return[];t.width=a.videoWidth,t.height=a.videoHeight,l.drawImage(a,0,0,t.width,t.height);const s=l.getImageData(0,0,t.width,t.height),n=document.createElement("canvas"),i=n.getContext("2d");if(!i)return[];n.width=e.width,n.height=e.height,i.drawImage(e,0,0);const d=i.getImageData(0,0,n.width,n.height);return await W(s,d,t.width,t.height)},W=async(a,e,t,l)=>{const s=[],n=[.3,.5,.7,1,1.3,1.6,2];for(const i of n){const n=Math.floor(e.width*i),d=Math.floor(e.height*i);if(!(n<.2*e.width||n>3*e.width)&&!(d<.2*e.height||d>3*e.height))for(let c=0;c<l-d;c+=12)for(let l=0;l<t-n;l+=12){const o=q(a,e,l,c,t,i);o>.4&&s.push({label:"目标图像",confidence:o,x:l,y:c,width:n,height:d})}}return s.length>0?(s.sort(((a,e)=>e.confidence-a.confidence)),[s[0]]):[]},q=(a,e,t,l,s,n=1)=>{let i=0,d=0,c=0;const o=Math.floor(e.width*n),v=Math.floor(e.height*n);for(let b=0;b<v;b+=2)for(let v=0;v<o;v+=2){const o=Math.floor(v/n),u=4*(Math.floor(b/n)*e.width+o),r=4*((l+b)*s+(t+v));if(r<a.data.length&&u<e.data.length){const t=(Math.abs(a.data[r]-e.data[u])+Math.abs(a.data[r+1]-e.data[u+1])+Math.abs(a.data[r+2]-e.data[u+2]))/3;i+=t,t<50&&c++,d++}}if(0===d)return 0;const u=i/d,r=c/d,h=.3*Math.max(0,1-u/255)+.7*r;return Math.max(0,Math.min(1,h))},z=a=>({left:`${a.x}px`,top:`${a.y}px`,width:`${a.width}px`,height:`${a.height}px`});return s((()=>{_()})),(a,t)=>(n(),i("div",ra,[d("div",ha,[ba,d("div",ma,[ga,d("div",pa,[g(d("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>M.value=a),type:"url",placeholder:"请输入网络图片URL",class:"image-url-input"},null,512),[[p,M.value]]),d("button",{onClick:$,disabled:!M.value,class:"btn btn-info"}," 加载目标图像 ",8,fa)]),d("div",ya,[wa,d("div",Ma,[d("button",{onClick:t[1]||(t[1]=a=>I("https://cpe-oss-h5.oss-cn-shenzhen.aliyuncs.com/h5/20250726/image-v1/icon/role-2.png")),class:"btn btn-sm btn-outline"}," 示例图片1 "),d("button",{onClick:t[2]||(t[2]=a=>I("https://cpe-oss-h5.oss-cn-shenzhen.aliyuncs.com/h5/20250726/image-v1/icon/merge-prize-6.png")),class:"btn btn-sm btn-outline"}," 示例图片2 "),d("button",{onClick:t[3]||(t[3]=a=>I("https://cpe-oss-h5.oss-cn-shenzhen.aliyuncs.com/h5/20250726/image-v1/icon/lottery-1.png")),class:"btn btn-sm btn-outline"}," 示例图片3 ")])]),x.value?(n(),i("div",xa,[d("img",{src:M.value,alt:"目标图像",class:"preview-image"},null,8,ka),Ca])):r("",!0)]),d("div",_a,[d("button",{onClick:C,disabled:h.value,class:"btn btn-primary"}," 启动摄像头 ",8,Aa),d("button",{onClick:_,disabled:!h.value,class:"btn btn-danger"}," 停止摄像头 ",8,Ea),d("button",{onClick:A,disabled:!h.value||!x.value,class:"btn btn-secondary"},c(b.value?"停止识别":"开始识别"),9,ja)])]),d("div",$a,[d("div",Ia,[d("video",{ref_key:"videoElement",ref:e,autoplay:"",muted:"",playsinline:"",class:"video-stream"},null,512),d("canvas",{ref_key:"canvasElement",ref:l,class:"overlay-canvas"},null,512),(n(!0),i(o,null,v(m.value,((a,e)=>(n(),i("div",{key:e,class:"detection-overlay",style:u(z(a))},[a.confidence>.7?(n(),i("div",Da,Fa)):r("",!0),d("div",{class:"bounding-box",style:u({width:"100%",height:"100%"})},Wa,4),d("div",qa,c(a.label)+" ("+c(Math.round(100*a.confidence))+"%) ",1)],4)))),128))]),d("div",za,[Pa,d("div",Ra,[d("p",null,"摄像头状态: "+c(h.value?"已启动":"未启动"),1),d("p",null,"识别状态: "+c(b.value?"识别中":"已停止"),1),d("p",null,"目标图像: "+c(x.value?"已加载":"未加载"),1),d("p",null,"检测到对象: "+c(m.value.length)+" 个",1),b.value?(n(),i("div",Ha,Oa)):r("",!0)]),m.value.length>0?(n(),i("div",Ta,[Ua,(n(!0),i(o,null,v(m.value,((a,e)=>(n(),i("div",{key:e,class:"detection-item"},[d("p",null,[La,f(" "+c(a.label),1)]),d("p",null,[Va,f(" "+c(Math.round(100*a.confidence))+"%",1)]),d("p",null,[Ba,f(" ("+c(Math.round(a.x))+", "+c(Math.round(a.y))+")",1)]),d("p",null,[Sa,f(" "+c(Math.round(a.width))+" × "+c(Math.round(a.height)),1)])])))),128))])):r("",!0)])]),y(va,{"is-camera-active":h.value,"video-element":e.value||null},null,8,["is-camera-active","video-element"])]))}}),[["__scopeId","data-v-b9ee6d68"]]);export{Ga as default};
