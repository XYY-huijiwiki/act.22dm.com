import{_ as a,d as l,Y as e,r as s,j as n,k as t,q as o,a as c,Z as i,o as r,c as u,b as v,F as d,A as p,n as m,B as f,z as g,t as y,w as h,C as w,D as b,E as k,f as C,T as I,I as M,p as _,h as x}from"./index-32760765.js";const R=a=>(_("data-v-e0d60bfc"),a=a(),x(),a),$=R((()=>v("div",{class:"bg-game-1"},null,-1))),z={class:"game-map"},E={key:1,class:"icon icon-g-3"},A={key:2,class:"cell-mechanism"},D={key:0,class:"mechanism-progress"},j={class:"bg-game-2"},q={class:"game-controls"},B={class:"control-row"},F=[R((()=>v("span",{class:"btn-dir-icon"},null,-1)))],G={class:"control-row"},T=[R((()=>v("span",{class:"btn-dir-icon"},null,-1)))],Y=R((()=>v("span",{class:"btn-dir btn-dir-center"},null,-1))),Z=[R((()=>v("span",{class:"btn-dir-icon"},null,-1)))],H={class:"control-row"},J=[R((()=>v("span",{class:"btn-dir-icon"},null,-1)))],K=R((()=>v("span",{class:"icon-game-timer"},null,-1))),L={class:"icon-game-timer-text"},N={id:"page-dialogs"},O={key:0,class:"dialogs-start"},P={class:"bg-game-tips"},Q=[R((()=>v("div",{class:"bg-game-success"},null,-1)))],S=[R((()=>v("div",{class:"bg-game-fail"},null,-1)))],U=a(l({__name:"game",emits:["close","playAudio","play"],setup(a,{emit:l}){e();const _=s(!["localhost"].includes(location.hostname)||["localhost"].includes(location.hostname)&&n()),x=s(t(1600,!_.value)),R=s("start"),U=s(""),V=s([0,0]),W=s(120),X=s(null),aa=s(null),la=s(null),ea=s(!1),sa=s(1),na=[[[1,1,1,3,0,2,0,0,0,0,3,0],[0,4,0,0,0,4,0,0,2,0,3,0],[0,2,2,0,0,2,0,0,2,3,4,2],[0,2,0,0,1,1,3,0,0,0,0,2],[3,3,0,2,2,2,4,3,0,1,1,2],[1,0,0,0,2,0,0,0,0,3,0,0]],[[3,1,0,3,0,0,0,2,0,3,3,0],[0,0,0,0,4,1,0,2,0,0,0,0],[0,2,0,0,0,2,2,0,3,4,0,2],[2,4,0,2,0,0,0,0,2,3,0,2],[1,3,0,2,3,3,1,0,1,1,0,3],[1,0,0,0,2,1,0,4,0,0,0,2]]],ta=[[{direction:"vertical",start:[2,4],end:[0,4]},{direction:"vertical",start:[0,7],end:[3,7]},{direction:"horizontal",start:[3,10],end:[3,7]}],[{direction:"vertical",start:[0,2],end:[5,2]},{direction:"horizontal",start:[3,4],end:[3,7]},{direction:"horizontal",start:[1,8],end:[1,11]}]],oa=[5,1],ca=s([]),ia=s([]),ra=s(null),ua=s(5);const va=o((()=>ca.value));function da(a,l){const e=ua.value;return"fail"===R.value&&ra.value&&ra.value[0]===a&&ra.value[1]===l?`icon-r-${e}-2`:`icon-r-${e}-1`}function pa(){const a=sa.value;return"fail"===R.value&&ra.value?`icon-r-${a}-2`:`icon-r-${a}-1`}function ma(a,l){var e;const s=null==(e=ca.value[a])?void 0:e[l];return"grass"===(null==s?void 0:s.type)}function fa(a){const l=Math.floor(a/60),e=a%60;return(l<10?"0":"")+l+" : "+(e<10?"0":"")+e}function ga(a){if(!ea.value||["success","fail"].includes(R.value))return;const[e,s]=V.value;let n=e,t=s;"up"===a?n--:"down"===a?n++:"left"===a?t--:t++,function(a,l){return!(a<0||a>=6||l<0||l>=12)&&"floor"!==ca.value[a][l].type}(n,t)&&(V.value=[n,t],ya(),function(){var a;const[l,e]=V.value,s=null==(a=ca.value[l])?void 0:a[e];if("mechanism"!==(null==s?void 0:s.type)||s.activated)wa(),ha();else if(!s.activating){s.activating=!0,s.progress=0;const a=Date.now();la.value=window.setInterval((()=>{var l;if(!ea.value)return;const[e,s]=V.value,n=null==(l=ca.value[e])?void 0:l[s];if("mechanism"!==(null==n?void 0:n.type)||n.activated)return wa(),void ha();const t=(Date.now()-a)/1e3,o=Math.min(100,t/5*100);n.progress=o,o>=100&&(n.activated=!0,n.activating=!1,n.progress=0,wa(),function(){const a=ca.value.every((a=>a.every((a=>"mechanism"!==a.type||a.activated))));a&&ka("success","")}())}),100)}}(),l("playAudio","out"))}function ya(){const[a,l]=V.value;for(const e of ia.value)if(e.row===a&&e.col===l)return ra.value=[e.row,e.col],void ka("fail","碰到了坏人！")}function ha(){ca.value.forEach((a=>{a.forEach((a=>{"mechanism"!==a.type||a.activated||(a.activating=!1,a.progress=0)}))}))}function wa(){la.value&&(clearInterval(la.value),la.value=null)}function ba(){if(!ea.value)return;const a=ca.value;ia.value.forEach((l=>{var e;a[l.row][l.col].enemy=void 0;let s=l.row,n=l.col;if("horizontal"===l.direction){const a=Math.min(l.startCol,l.endCol),e=Math.max(l.startCol,l.endCol);0===l.step?(n=l.col<e?l.col+1:l.col-1,l.col===e&&(l.step=1)):(n=l.col>a?l.col-1:l.col+1,l.col===a&&(l.step=0)),n=Math.max(a,Math.min(e,n))}else{const a=Math.min(l.startRow,l.endRow),e=Math.max(l.startRow,l.endRow);0===l.step?(s=l.row<e?l.row+1:l.row-1,l.row===e&&(l.step=1)):(s=l.row>a?l.row-1:l.row+1,l.row===a&&(l.step=0)),s=Math.max(a,Math.min(e,s))}const t=null==(e=a[s])?void 0:e[n];t&&"floor"!==t.type&&s>=0&&s<6&&n>=0&&n<12?(l.row=s,l.col=n):l.step=0===l.step?1:0,a[l.row][l.col].enemy={direction:l.direction,step:l.step}})),ca.value=[...a],ya()}function ka(a,e){ea.value=!1,X.value&&(clearInterval(X.value),X.value=null),aa.value&&(clearInterval(aa.value),aa.value=null),wa(),U.value=e,R.value=a,l("playAudio","success"===a?"success":"fail")}function Ca(a){0!==a?(l("play"),R.value="",ra.value=null,sa.value=M(1,4),function(a=null){const l=a||Math.floor(2*Math.random()),e=ta[l],s={0:"empty",1:"floor",2:"floor",3:"grass",4:"mechanism"},n=na[l].map(((a,l)=>a.map(((a,l)=>({type:s[a]??"empty",style:1===a||2===a?a:void 0,activated:!1,activating:!1,progress:0,enemy:void 0})))));ua.value=0===l?5:6,ia.value=[],e.forEach((({direction:a,start:[l,e],end:[s,t]})=>{var o;(null==(o=n[l])?void 0:o[e])&&(n[l][e].enemy={direction:a,step:0},ia.value.push({row:l,col:e,direction:a,step:0,startRow:l,startCol:e,endRow:s,endCol:t}))})),ca.value=n}(),V.value=[...oa],ea.value=!0,W.value=120,X.value=setInterval((()=>{W.value--,W.value<=0&&ka("fail","时间到了，未激活所有机关")}),1e3),aa.value=setInterval(ba,800)):l("close",{success:0})}function Ia(){ea.value=!1,X.value&&clearInterval(X.value),aa.value&&clearInterval(aa.value),wa(),l("close",{success:"success"===R.value})}return c((()=>{V.value=[...oa]})),i((()=>{X.value&&clearInterval(X.value),aa.value&&clearInterval(aa.value),wa()})),(a,l)=>(r(),u("div",{id:"page-dungeon-game",class:m({m:_.value})},[v("div",{class:"scene-game",style:f(`transform:scale(${x.value})`)},[$,v("div",z,[(r(!0),u(d,null,p(va.value,((a,l)=>(r(),u("div",{key:"row-"+l,class:"map-row"},[(r(!0),u(d,null,p(a,((a,e)=>(r(),u("div",{key:"cell-"+l+"-"+e,class:"map-cell"},["floor"===a.type?(r(),u("div",{key:0,class:m(["icon","icon-g-"+(a.style??1)])},null,2)):"grass"===a.type?(r(),u("div",E)):"mechanism"===a.type?(r(),u("div",A,[v("div",{class:m(["icon",a.activated?"icon-g-4-1":"icon-g-4"])},null,2),a.activating?(r(),u("div",D,[v("div",{class:"mechanism-progress-bar",style:f(`width:${a.progress}%`)},null,4)])):g("",!0)])):g("",!0),a.enemy?(r(),u("div",{key:3,class:m(["icon",da(l,e)])},null,2)):g("",!0),V.value[0]===l&&V.value[1]===e?(r(),u("div",{key:4,class:m(["icon",pa(),{inGrass:ma(l,e)}])},null,2)):g("",!0)])))),128))])))),128))]),v("div",j,[v("div",q,[v("div",B,[v("span",{class:"btn-dir btn-dir-up",onClick:l[0]||(l[0]=a=>ga("up"))},F)]),v("div",G,[v("span",{class:"btn-dir btn-dir-left",onClick:l[1]||(l[1]=a=>ga("left"))},T),Y,v("span",{class:"btn-dir btn-dir-right",onClick:l[2]||(l[2]=a=>ga("right"))},Z)]),v("div",H,[v("span",{class:"btn-dir btn-dir-down",onClick:l[3]||(l[3]=a=>ga("down"))},J)])]),v("span",{class:"btn-game-back",onClick:l[4]||(l[4]=a=>Ia())}),K,v("span",L,y(fa(W.value)),1)])],4),h(v("div",N,[b(I,{name:"fade"},{default:k((()=>["start"===R.value?(r(),u("div",O,[v("div",P,[v("span",{class:"game-tips-start",onClick:l[5]||(l[5]=C((a=>Ca(1)),["stop"]))}),v("span",{class:"game-tips-close",onClick:l[6]||(l[6]=C((a=>Ca(0)),["stop"]))})])])):g("",!0)])),_:1}),b(I,{name:"fade"},{default:k((()=>["success"===R.value?(r(),u("div",{key:0,onClick:l[7]||(l[7]=a=>Ia())},Q)):g("",!0)])),_:1}),b(I,{name:"fade"},{default:k((()=>["fail"===R.value?(r(),u("div",{key:0,onClick:l[8]||(l[8]=a=>Ia())},S)):g("",!0)])),_:1})],512),[[w,R.value]])],2))}}),[["__scopeId","data-v-e0d60bfc"]]);export{U as default};
