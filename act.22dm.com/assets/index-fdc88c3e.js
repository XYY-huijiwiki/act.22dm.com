import{_ as e,d as a,ah as s,o as l,c as i,D as n,E as t,T as o,z as r,n as d,w as c,b as p,F as u,A as g,X as m,Y as y,u as k,l as h,k as v,q as f,a as b,s as w,P as C,x as B,a6 as L,B as T,f as x,C as z,t as S,ab as P,I as _,L as I,ai as R,ac as U,a2 as $,aj as A,R as N,ad as j,V as D,S as E,U as K,p as q,h as M}from"./index-32760765.js";import{w as O}from"./wxjssdk-01858e27.js";import{L as W}from"./loupe-305540f3.js";import{B as V}from"./board-f19e3f79.js";import{o as J}from"./oss-aaa8863a.js";import{g as Y}from"./sign-629db278.js";import{T as F,I as G}from"./index-89f89943.js";import"./isObjectLike-38825d63.js";let H,X,Z,Q="https://cpe-app-oss.oss-cn-shenzhen.aliyuncs.com/h5/bottle2/image2";const ee=a({name:"bottle2",components:{Loupe:W,Textarea:F,Input:G},setup(e,a){var s,l;const{proxy:i}=K();let n=new O({});y();let t=null;const o=k(),r=h({k:"",imgUrl:Q,userInfo:(null==(s=o.params)?void 0:s.userInfo)??{},spinning:!1,volume:!1,loupe:!1,loupeList:[],shareData:null,scene:"",dialogs:"",scale:v(1500),showArrow:!0,share:!1,audioList:[{name:"bgm",src:`${Q}/bgm.mp3`,loop:!0},{name:"start",src:`${Q}/start.mp3`},{name:"click",src:`${Q}/click.mp3`},{name:"open",src:`${Q}/open.mp3`}],currBottle:null,fishToday:0,fishList:[],sendToday:0,sendList:[],paintToday:0,signDay:0,signToday:!0,hasPurple:!0,hasReward:!1,prizeAlready:!1,canSign:!0,canPrize:!1,paintConfig:{canvasId:"paint-canvas",strokeStyle:"#dbd7dc",lineWidth:3,backgroundColor:"",brushWidth:30},ratio:[],prizeRatio:0,redpacketRatio:0,wallpaperList:[],wxList:[],form:{phone:"",name:"",address:""},whiteList:["ofN_u6nBbWm3k8KmgyWetjEKIGaE","ofN_u6kSinBv-J6VPcZevtbsM6HE","ofN_u6grqvWP-jakjV0ch6OCR3mY"],redpacketList:[],redpacketAlready:!1,redpacketCount:0});Z=(null==(l=r.userInfo)?void 0:l.unionid)??"";const d=f((()=>{let e=!1;return 5===r.currBottle.ballId&&3!==r.currBottle.type&&(e=!0),e})),c=(e=0,a=1)=>{if(r.spinning)return;let s=R(r.currBottle);e&&(s.del=e);let l={ownerUnionid:Z,playType:1,periodNum:3,content:s};r.spinning=!0,U(l).then((({code:s})=>{0==s&&(r.fishToday++,e||(r.fishList.push(l.content),a&&(r.scene="record"),p()))})).catch((e=>{g("活动次数达到上限")})).finally((()=>{a&&(r.currBottle=null,r.dialogs=""),r.spinning=!1})),9999===s.type&&U({ownerUnionid:Z,playType:2,bottleType:1,periodNum:3,content:{prize:1}})},p=()=>{r.spinning=!0,j({unionid:Z,periodNum:3}).then((({code:e,data:a})=>{0===e&&(r.fishToday=0,r.sendToday=0,r.signToday=!0,r.signDay=0,r.canPrize=!1,r.paintToday=a.bottle2Count,a.playType1.forEach((e=>{var a,s,l,i;999===(null==(a=e.content)?void 0:a.type)?r.signDay++:9999===(null==(s=e.content)?void 0:s.type)?r.prizeAlready=!0:8888===(null==(l=e.content)?void 0:l.type)&&(r.redpacketAlready=!0),(null==e?void 0:e.addTime)&&D(e.addTime)&&(999===(null==(i=e.content)?void 0:i.type)||(r.fishToday++,5===e.content.type&&(r.hasPurple=!1)))})),r.canSign&&r.signToday,a.playType2.forEach((e=>{(null==e?void 0:e.addTime)&&D(e.addTime)&&r.sendToday++})),r.fishList=a.playType1.map((e=>e.content)).filter((e=>!e.del)),r.sendList=a.playType2.map((e=>e.content)),r.whiteList.includes(Z)&&(r.canPrize=!0))})).catch((e=>{})).finally((()=>{r.spinning=!1}))},u=(e,a=!1)=>{E(r,e,a)},g=e=>{i.$Message.success(e)};return b((()=>{var e,a,s;window.addEventListener("beforeunload",(e=>{var a;(null==(a=r.currBottle)?void 0:a.type)&&"record"!=r.scene&&9999!==r.currBottle.type&&8888!==r.currBottle.type&&(c(),null==e||e.preventDefault())})),H=(null==(e=o.meta)?void 0:e.activityKey)??"bottle2",X=(null==(a=o.meta)?void 0:a.periodNum)??1;let l=location.origin+o.path,i=(null==(s=o.meta)?void 0:s.imgUrl)??"";o.query.shareData&&(r.shareData=JSON.parse(decodeURIComponent(o.query.shareData))),w({activityKey:H,periodNum:X}).then((({code:e,data:a})=>{0===e&&(r.k=a.k,r.paintConfig=a.extra.paintConfig,r.wallpaperList=a.extra.wallpaperList,r.ratio=a.extra.ratio,r.wxList=a.extra.wxList,r.canSign=a.extra.canSign??!0,r.prizeRatio=a.extra.prizeRatio??0,r.redpacketRatio=a.extra.redpacketRatio??0,r.redpacketList=[],p(),C({unionid:Z,activityKey:"bottleReward",periodNum:3}).then((({code:e,data:a})=>{(null==a?void 0:a.name)&&(r.hasReward=!0)})))})),n.ready((()=>{var e,a;u("bgm",!0),n.updateShareData({title:(null==(e=o.meta)?void 0:e.title)??"",desc:(null==(a=o.meta)?void 0:a.desc)??"",link:l,imgUrl:i}),document.addEventListener("visibilitychange",(e=>{document.hidden?B():r.volume&&u("bgm",!0)}))}))})),{...L(r),onPlayAudio:u,showMessage:g,onStartCollect:()=>{var e;r.spinning||(null==(e=r.wallpaperList)?void 0:e.length)&&(r.spinning=!0,P({activityKey:H,periodNum:X}).then((({code:e,data:a})=>{0===e&&(r.redpacketCount=a.playCount,r.showArrow=!1,"machine"!==r.scene&&(r.fishToday<3?(r.scene="machine",setTimeout((()=>{u("start"),setTimeout((()=>{u("open")}),4e3)}),500),setTimeout((()=>{let e,a,s;r.scene="";let l=_(1,100),i=_(1,100),n=_(1,100);r.whiteList.includes(Z)&&(i=0,n=0);for(let t=0;t<r.ratio.length;t++)if(l<r.ratio[t]){a=t;break}if(r.signToday&&r.hasPurple)if(e=5,a=4,!r.redpacketAlready&&r.redpacketCount<r.redpacketList.length&&i<=r.redpacketRatio){let e=r.redpacketList[r.redpacketCount];s={id:"8888.png",type:8888,code:e},r.redpacketAlready=!0,r.redpacketCount++;let{k:a}=r,l=Y({k:a,unionid:Z,score:0,level:0});I({ownerUnionid:Z,activityKey:H,gameScore:0,levelNum:0,playTime:0,extra:{code:e},k:a,s:l})}else!r.prizeAlready&&r.canPrize&&n<=r.prizeRatio?(r.prizeAlready=!0,s={id:"9999-0420.png",type:9999}):a=2;a<=2&&(e||(e=_(1,4)),s=r.wallpaperList[a][_(0,r.wallpaperList[a].length-1)]),r.currBottle={ballId:e,img:s.id,type:s.type},8888===s.type&&(r.currBottle.code=s.code),r.currBottle.open=!0,8888!==s.type&&9999!==s.type||c(0,0)}),6e3)):g("今天参与次数已达上限(每天3次)")))})).finally((()=>{r.spinning=!1})))},onStartPaint:()=>{r.sendList.length>=3?g("今天参与次数已达上限(每天1次)"):r.paintToday>=30?g("每日收集扭蛋上限为30个,请明天再来"):(r.scene="paint",setTimeout((()=>{t=new V(document.getElementById("container"),r.paintConfig)}),200))},onSaveBottle:c,onSavePaint:()=>{if(r.spinning)return;let e=document.getElementById(r.paintConfig.canvasId).toDataURL("image/png"),a=$()+".png",s=A(e,a),l=`h5/bottle2/upload/${a}`;r.spinning=!0,J(s,l).then((e=>{U({ownerUnionid:Z,playType:2,bottleType:2,periodNum:3,content:{img:e}}).then((({code:e})=>{0==e&&(r.dialogs="",r.scene="",g("提交成功"))}))})).catch((e=>{g(e),r.spinning=!1}))},onNextRecord:e=>{let a=r.fishList.findIndex((e=>r.currBottle==e));a===r.fishList.length-1&&1===e?(r.fishList[0].record=!0,r.fishList[0].open=!0,r.currBottle=r.fishList[0]):0===a&&-1===e?(r.fishList[r.fishList.length-1].record=!0,r.fishList[r.fishList.length-1].open=!0,r.currBottle=r.fishList[r.fishList.length-1]):(r.fishList[a+e].record=!0,r.fishList[a+e].open=!0,r.currBottle=r.fishList[a+e])},onLoupe:e=>{if(e){let{type:a}=e;if(3==a||5==a)r.loupeList=[`${Q}/wallpaper/${r.currBottle.img}`],r.loupe=!0;else if(4==a){let e=r.wxList[_(0,r.wxList.length-1)];location.href=e}}},onPaintCtrl:e=>{t&&("rubber"===e?t.setContext2DStyle({strokeStyle:"#000"}):"brush"===e?t.setContext2DStyle(r.paintConfig):"clear"===e&&t.clear())},onSign:()=>{if(!r.spinning)if(r.signToday)g("今日已签到");else{r.spinning=!0,U({ownerUnionid:Z,playType:1,periodNum:3,content:{type:999}}).then((({code:e})=>{0==e&&(r.signToday=!0,r.signDay++,g("签到成功"))})).finally((()=>{r.spinning=!1}))}},onSubmitAward:()=>{if(r.hasReward)return r.dialogs="",r.currBottle=null,void g("你已提交过信息");let{phone:e,name:a,address:s}=r.form;if(a&&e&&s)if(11==e.length){if(r.spinning)return;r.spinning=!0,N({activityKey:"bottleReward",periodNum:3,ownerUnionid:Z,address:s,name:a,phone:e,extra:{}}).then((()=>{r.dialogs="",r.currBottle=null,r.hasReward=!0,g("提交成功")})).finally((()=>{r.spinning=!1}))}else g("请填写11位手机号码");else g("请输入正确的信息")},showRedpacket:e=>{window.open(`https://support.weixin.qq.com/cgi-bin/mmsupport-bin/showredpacket?receiveuri=${e}&check_type=2#wechat_redirect`)},isPrizeBall:d}}}),ae=e=>(q("data-v-0b307d94"),e=e(),M(),e),se={id:"page"},le={id:"scene-mm",class:"scene-layer bg-mm"},ie=ae((()=>p("span",{class:"icon-logo"},null,-1))),ne=ae((()=>p("span",{class:"icon-reserved"},null,-1))),te=ae((()=>p("div",{class:"mm-title"},[p("span",{class:"icon-mm-star1"}),p("span",{class:"icon-mm-star2"}),p("span",{class:"icon-mm-title"})],-1))),oe={class:"mm-machine"},re=["src"],de={key:1,class:"machine-layer icon-machine"},ce={class:"mm-btn"},pe={class:"mm-btn-list"},ue={class:"mm-select"},ge=["src"],me={class:"bg-dialogs-main"},ye=["src"],ke={class:"bg-dialogs-btn"},he={key:0,id:"scene-paint",class:"scene-layer"},ve={class:"bg-paint"},fe={class:"paint-btn"},be=ae((()=>p("span",{class:"paint-tips"},null,-1))),we=ae((()=>p("div",{id:"container"},null,-1))),Ce={key:0,id:"scene-record",class:"scene-layer bg-mm"},Be={class:"record-list"},Le=["onClick"],Te={key:0,id:"page-dialogs",class:"scene-layer"},xe={key:0,class:"dialogs-sign-2"},ze={class:"bg-sign-2"},Se={key:0},Pe={class:"dialogs-sign"},_e={class:"bg-sign"},Ie={key:0},Re={class:"dialogs-award bg-award"},Ue={key:0},$e={key:0},Ae={class:"dialogs-save bg-sign-tips"},Ne={key:0},je={class:"dialogs-save bg-save"},De=[ae((()=>p("div",{class:"bg-rule-0420"},null,-1)))],Ee={key:0},Ke={class:"dialogs-exit bg-exit"},qe=[ae((()=>p("div",{class:"bg-full"},null,-1)))],Me=[ae((()=>p("div",{class:"dialogs-share icon-share"},null,-1)))],Oe={id:"audio-list"},We=["id","src","loop"];const Ve=e(ee,[["render",function(e,a,y,k,h,v){const f=s("Input"),b=s("Textarea"),w=s("Loupe");return l(),i("div",se,[n(o,{name:"fade"},{default:t((()=>[p("div",le,[ie,ne,p("div",{class:"mm-main",style:T(`transform:scale(${e.scale})`)},[te,p("div",oe,[n(o,{name:"fade"},{default:t((()=>["machine"==e.scene?(l(),i("img",{key:0,class:"machine-layer",src:`${e.imgUrl}/ball/start.gif`},null,8,re)):(l(),i("div",de))])),_:1})]),p("div",ce,[p("div",pe,[p("span",{class:"btn-mm-rank",onClick:a[0]||(a[0]=a=>e.showMessage("暂未开放"))}),p("span",{class:"btn-mm-record2",onClick:a[1]||(a[1]=a=>e.scene="record")})]),p("span",{class:"btn-mm-collect",onClick:a[2]||(a[2]=a=>{e.onStartCollect(),e.onPlayAudio("click")})}),e.showArrow?(l(),i("span",{key:0,class:"icon-arrow",onClick:a[3]||(a[3]=a=>e.onStartCollect())})):r("",!0)])],4),p("div",ue,[p("span",{class:"btn-rule",onClick:a[4]||(a[4]=a=>e.dialogs="rule")})]),e.currBottle?(l(),i("div",{key:0,class:"mm-dialogs scene-layer",onClick:a[15]||(a[15]=x((a=>e.currBottle.record&&5===e.currBottle.ballId?e.currBottle=null:null),["self"]))},[e.currBottle.open||e.currBottle.prizeing?r("",!0):(l(),i("div",{key:0,class:d(["ball-open",[`ball-${e.currBottle.ballId}`]])},null,2)),e.currBottle.prizeing?(l(),i("img",{key:1,class:"ball-prizeing",src:`${e.imgUrl}/ball/prizeing.gif`},null,8,ge)):r("",!0),n(o,{name:"fade"},{default:t((()=>[e.currBottle.open?(l(),i("div",{key:0,class:d(["ball-opened",{prize:e.isPrizeBall}])},[p("div",{class:d(["ball-opened-bottom",`ball-${e.currBottle.ballId}-active`])},null,2),p("div",{class:d(["ball-opened-main",e.isPrizeBall?"bg-prize":"bg-dialogs"])},[p("div",me,[p("img",{src:`${e.imgUrl}/wallpaper/${e.currBottle.img}`,onClick:a[5]||(a[5]=a=>e.onLoupe(e.currBottle))},null,8,ye)]),p("div",ke,[e.isPrizeBall?r("",!0):(l(),i("span",{key:0,class:"btn-share",onClick:a[6]||(a[6]=a=>e.share=!0)})),e.currBottle.record?(l(),i(u,{key:2},[9999===e.currBottle.type||8888===e.currBottle.type?(l(),i(u,{key:0},[p("span",{class:"btn-award0",onClick:a[11]||(a[11]=a=>e.dialogs=9999===e.currBottle.type?e.currBottle=null:"redpacket-tips-1")}),p("span",{class:"btn-award1",onClick:a[12]||(a[12]=a=>9999===e.currBottle.type?e.hasReward?e.showMessage("你已填写过收货信息"):e.dialogs="award":e.dialogs="redpacket-tips-2")})],64)):r("",!0)],64)):(l(),i(u,{key:1},[9999!==e.currBottle.type&&8888!==e.currBottle.type?(l(),i(u,{key:0},[p("span",{class:"btn-like",onClick:a[7]||(a[7]=a=>e.onSaveBottle())}),p("span",{class:"btn-del",onClick:a[8]||(a[8]=a=>e.onSaveBottle(1))})],64)):(l(),i(u,{key:1},[p("span",{class:"btn-award0",onClick:a[9]||(a[9]=a=>e.dialogs=9999===e.currBottle.type?"prize-tips":"redpacket-tips-1")}),p("span",{class:"btn-award1",onClick:a[10]||(a[10]=a=>e.dialogs=9999===e.currBottle.type?"award":"redpacket-tips-2")})],64))],64))]),e.currBottle.record&&e.fishList.length>1&&!e.isPrizeBall?(l(),i("span",{key:0,class:"dialogs-close",onClick:a[13]||(a[13]=a=>e.currBottle=null)})):(l(),i("span",{key:1,class:"dialogs-close",onClick:a[14]||(a[14]=a=>e.onSaveBottle(1))}))],2)],2)):r("",!0)])),_:1})])):r("",!0),n(o,{name:"fade"},{default:t((()=>["paint"==e.scene?(l(),i("div",he,[p("div",ve,[p("span",{class:"paint-close",onClick:a[16]||(a[16]=a=>e.dialogs="exit")}),p("span",{class:"paint-save",onClick:a[17]||(a[17]=a=>e.sendList.length>=30?e.showMessage("剩余参与次数为0"):e.dialogs="save")}),p("div",fe,[p("span",{class:"btn-rubber",onClick:a[18]||(a[18]=a=>e.onPaintCtrl("rubber"))}),p("span",{class:"btn-brush",onClick:a[19]||(a[19]=a=>e.onPaintCtrl("brush"))}),p("span",{class:"btn-clear",onClick:a[20]||(a[20]=a=>e.onPaintCtrl("clear"))})]),be,we])])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["record"==e.scene?(l(),i("div",Ce,[p("span",{class:"btn-back",onClick:a[21]||(a[21]=a=>e.scene="")}),p("div",Be,[(l(!0),i(u,null,g(e.fishList,((a,s)=>c((l(),i("span",{key:"record-item-"+s,class:d(`ball-${a.ballId}-normal`),onClick:s=>{a.record=!0,a.open=!0,e.currBottle=a}},null,10,Le)),[[z,1!=a.del]]))),128))])])):r("",!0)])),_:1})])])),_:1}),e.dialogs||e.share?(l(),i("div",Te,[n(o,{name:"fade"},{default:t((()=>[-1!==e.dialogs.indexOf("redpacket-tips")?(l(),i("div",{key:0,class:"redpacket-tips",onClick:a[23]||(a[23]=a=>"redpacket-tips-1"==e.dialogs?(e.dialogs="",e.currBottle=null):(e.showRedpacket(e.currBottle.code),e.currBottle=null,e.dialogs=""))},[p("div",{class:d(`bg-${e.dialogs}`)},[p("span",{class:"redpacket-tips-close",onClick:a[22]||(a[22]=x((a=>{e.currBottle=null,e.dialogs=""}),["stop"]))})],2)])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["sign-2"==e.dialogs?(l(),i("div",xe,[p("div",ze,[p("span",{class:d(["sign-btn",e.signToday?"btn-sign2-2":"btn-sign2-1"]),onClick:a[24]||(a[24]=a=>e.onSign())},null,2),p("span",{class:"sign-back",onClick:a[25]||(a[25]=a=>e.dialogs="")})])])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["sign"==e.dialogs?(l(),i("div",Se,[p("div",Pe,[p("div",_e,[p("span",{class:d(["sign-btn",e.signToday?"btn-sign2":"btn-sign1"]),onClick:a[26]||(a[26]=a=>e.onSign())},null,2)]),p("span",{class:"btn-back",onClick:a[27]||(a[27]=a=>e.dialogs="")})])])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["award"==e.dialogs?(l(),i("div",Ie,[p("div",Re,[n(f,{class:"award-name",value:e.form.name,"onUpdate:value":a[28]||(a[28]=a=>e.form.name=a)},null,8,["value"]),n(b,{class:"award-address",value:e.form.address,"onUpdate:value":a[29]||(a[29]=a=>e.form.address=a)},null,8,["value"]),n(f,{class:"award-phone",value:e.form.phone,"onUpdate:value":a[30]||(a[30]=a=>e.form.phone=a)},null,8,["value"]),p("span",{class:"award-submit",onClick:a[31]||(a[31]=a=>e.onSubmitAward())}),p("span",{class:"award-close",onClick:a[32]||(a[32]=a=>e.dialogs="")})])])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["prize-tips"==e.dialogs?(l(),i("div",Ue,[p("div",{class:"dialogs-save bg-prize-tips",onClick:a[33]||(a[33]=a=>{e.dialogs="",e.currBottle=null})})])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["sign-tips"==e.dialogs?(l(),i("div",$e,[p("div",Ae,[p("span",{class:"item-ok",onClick:a[34]||(a[34]=a=>e.dialogs="sign")}),p("span",{class:"item-cancel",onClick:a[35]||(a[35]=a=>e.dialogs="")})])])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["save"==e.dialogs?(l(),i("div",Ne,[p("div",je,[p("i",null,S(2-e.sendList.length),1),p("span",{class:"item-ok",onClick:a[36]||(a[36]=a=>e.onSavePaint())}),p("span",{class:"item-cancel",onClick:a[37]||(a[37]=a=>e.dialogs="")})])])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["rule"==e.dialogs?(l(),i("div",{key:0,onClick:a[38]||(a[38]=a=>e.dialogs="")},De)):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["exit"==e.dialogs?(l(),i("div",Ee,[p("div",Ke,[p("span",{class:"item-ok",onClick:a[39]||(a[39]=a=>{e.dialogs="",e.scene=""})}),p("span",{class:"item-cancel",onClick:a[40]||(a[40]=a=>e.dialogs="")})])])):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>["full"==e.dialogs?(l(),i("div",{key:0,onClick:a[41]||(a[41]=a=>e.dialogs="")},qe)):r("",!0)])),_:1}),n(o,{name:"fade"},{default:t((()=>[e.share?(l(),i("div",{key:0,onClick:a[42]||(a[42]=a=>e.share=!1)},Me)):r("",!0)])),_:1})])):r("",!0),e.audioList.length?(l(),i("div",{key:1,class:d(["btn-music",{active:e.volume}]),onClick:a[43]||(a[43]=a=>e.onPlayAudio("bgm",!0))},null,2)):r("",!0),c(p("div",Oe,[(l(!0),i(u,null,g(e.audioList,(e=>(l(),i("audio",{id:"audio-item-"+e.name,key:"audio-item-"+e.name,src:e.src,loop:e.loop??!1},null,8,We)))),128))],512),[[z,!1]]),e.loupe?(l(),m(w,{key:2,list:e.loupeList,currentIndex:null,onOnClose:a[44]||(a[44]=()=>{e.loupe=!1})},null,8,["list"])):r("",!0)])}],["__scopeId","data-v-0b307d94"]]);export{Ve as default};
